<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>Đặt Vé Xem Phim</title>
    <style>
        body {
            background-color: rgb(253, 252, 240);
        }
        .seat-container {
            margin-top: 20px;
        }
        .seat {
            display: inline-block;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            margin: 2px;
            border-radius: 5px;
            background-color: #d0d0d0;
            cursor: pointer;
        }
        .seat.selected {
            background-color: #007bff;
            color: #fff;
        }
        .seat.occupied {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .screen {
            text-align: center;
            font-weight: bold;
            margin: 20px 0;
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        .row {
            display: flex;
            justify-content: center; /* Căn giữa các hàng ghế */
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container seat-container">
        <h1>Đặt Vé Xem Phim</h1>
        <form id="booking-form">
            <div class="form-group">
                <label for="cinema-select">Chọn Rạp:</label>
                <select id="cinema-select" class="form-control" required>
                    <option value="">Chọn rạp</option>
                </select>
            </div>
            <div class="form-group">
                <label for="room-select">Chọn Phòng:</label>
                <select id="room-select" class="form-control" required>
                    <option value="">Chọn phòng</option>
                </select>
            </div>
            <div class="form-group">
                <label for="showtime-select">Chọn Suất Chiếu:</label>
                <select id="showtime-select" class="form-control" required>
                    <option value="">Chọn suất chiếu</option>
                </select>
            </div>
            <div class="screen">Màn Hình</div>
            <div id="seat-map">
                <!-- JavaScript sẽ tạo ghế ở đây -->
            </div>
            <button type="submit" id="confirm-btn" class="btn btn-primary mt-3">Xác nhận đặt vé</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cinemaSelect = document.getElementById('cinema-select');
            const roomSelect = document.getElementById('room-select');
            const showtimeSelect = document.getElementById('showtime-select');
            const seatMap = document.getElementById('seat-map');
            const bookingForm = document.getElementById('booking-form');

            // Load cinemas
            fetch('https://localhost:7074/api/Ve/cinemas')
                .then(response => response.json())
                .then(cinemas => {
                    cinemas.forEach(cinema => {
                        const option = document.createElement('option');
                        option.value = cinema.maRap;
                        option.textContent = cinema.tenRap;
                        cinemaSelect.appendChild(option);
                    });
                });

            // Load rooms when cinema is selected
            cinemaSelect.addEventListener('change', () => {
                const cinemaId = cinemaSelect.value;
                fetch(`https://localhost:7074/api/Ve/rooms/${cinemaId}`)
                    .then(response => response.json())
                    .then(rooms => {
                        roomSelect.innerHTML = '<option value="">Chọn phòng</option>';
                        rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.maPhong;
                            option.textContent = room.tenPhong;
                            roomSelect.appendChild(option);
                        });
                    });
            });

            // Load showtimes when room is selected
            roomSelect.addEventListener('change', () => {
                const roomId = roomSelect.value;
                fetch(`https://localhost:7074/api/Ve/showtimes/${roomId}`)
                    .then(response => response.json())
                    .then(showtimes => {
                        showtimeSelect.innerHTML = '<option value="">Chọn suất chiếu</option>';
                        showtimes.forEach(showtime => {
                            const option = document.createElement('option');
                            option.value = showtime.maSuatChieu;
                            option.textContent = `${showtime.ngayChieu} ${showtime.thoiGianBatDau}`;
                            showtimeSelect.appendChild(option);
                        });
                    });
            });

            // Generate seats
            const rows = 5; // Số hàng ghế
            const seatsPerRow = 15; // Số ghế mỗi hàng

            for (let i = 0; i < rows; i++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'row';
                for (let j = 0; j < seatsPerRow; j++) {
                    const seat = document.createElement('div');
                    seat.className = 'seat';
                    seat.textContent = `${String.fromCharCode(65 + i)}${j + 1}`;
                    seat.dataset.seatNumber = `${String.fromCharCode(65 + i)}${j + 1}`;
                    seat.addEventListener('click', () => {
                        if (!seat.classList.contains('occupied')) {
                            seat.classList.toggle('selected');
                        }
                    });
                    rowDiv.appendChild(seat);
                }
                seatMap.appendChild(rowDiv);
            }

            // Handle form submission
            bookingForm.addEventListener('submit', (event) => {
                event.preventDefault();

                const selectedSeats = Array.from(document.querySelectorAll('.seat.selected'))
                    .map(seat => seat.dataset.seatNumber);

                const ticketData = {
                    maSuatChieu: showtimeSelect.value,
                    maTK: 1, // Ví dụ: ID người dùng, cần thay đổi tùy theo logic của bạn
                    giaVe: 100000, // Ví dụ: Giá vé, cần thay đổi tùy theo logic của bạn
                    pttt: 'Tiền mặt',
                    viTri: selectedSeats.join(',') // Các số ghế đã chọn
                };

                fetch('https://localhost:7074/api/Ve/tickets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ticketData)
                })
                .then(response => response.json())
                .then(result => {
                    alert('Đặt vé thành công!');
                    // Xử lý thêm nếu cần
                })
                .catch(error => console.error('Error:', error));
            });
        });
    </script>
</body>
</html>
